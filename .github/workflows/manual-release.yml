name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.9.5 - without v prefix)'
        required: true
        type: string
      create_tag:
        description: 'Create git tag'
        required: true
        type: boolean
        default: true
      update_version_in_code:
        description: 'Update version in main.go'
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  actions: read

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update version in code
      if: ${{ github.event.inputs.update_version_in_code == 'true' }}
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "Updating version to ${VERSION} in cmd/termonaut/main.go"

        # Update version in main.go
        sed -i "s/version = \"[^\"]*\"/version = \"${VERSION}\"/" cmd/termonaut/main.go

        # Verify the change
        grep "version = " cmd/termonaut/main.go

    - name: Commit version update
      if: ${{ github.event.inputs.update_version_in_code == 'true' }}
      run: |
        VERSION="${{ github.event.inputs.version }}"

        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        git add cmd/termonaut/main.go
        git commit -m "🔖 Bump version to ${VERSION}" || echo "No changes to commit"
        git push

    - name: Create and push tag
      if: ${{ github.event.inputs.create_tag == 'true' }}
      run: |
        VERSION="v${{ github.event.inputs.version }}"

        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        echo "Creating tag: ${VERSION}"
        git tag -a "${VERSION}" -m "Release ${VERSION}

        🚀 Automated release via GitHub Actions
        📦 Cross-platform binaries included
        🌍 Supports: macOS (Intel/ARM64), Linux (x64/ARM64), Windows (x64)

        Release notes will be auto-generated by the release workflow."

        git push origin "${VERSION}"

        echo "✅ Tag ${VERSION} created and pushed"
        echo "🔄 This will trigger the main release workflow automatically"

    - name: Summary
      run: |
        VERSION="v${{ github.event.inputs.version }}"
        echo "🎉 Release preparation completed!"
        echo ""
        echo "📋 What happened:"
        if [ "${{ github.event.inputs.update_version_in_code }}" = "true" ]; then
          echo "  ✅ Updated version in cmd/termonaut/main.go"
        fi
        if [ "${{ github.event.inputs.create_tag }}" = "true" ]; then
          echo "  ✅ Created and pushed git tag: ${VERSION}"
          echo "  🔄 Main release workflow will start automatically"
        fi
        echo ""
        echo "🔗 Monitor the release progress at:"
        echo "   https://github.com/oiahoon/termonaut/actions"
        echo ""
        echo "📦 Release will be available at:"
        echo "   https://github.com/oiahoon/termonaut/releases/tag/${VERSION}"